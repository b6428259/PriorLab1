@startuml
title buyItem(playerId: Integer, itemId: Integer)

actor User as u
boundary API as a
database Database as d

u->a : POST /api/v1/market/buy(playerId, itemId)
a->d : Find market item by itemId
alt Market item not found
    a->u : 400 Bad Request
    a->u : "Market item not found with ID: itemId"
else Market item found
    a->a : Find player by playerId
    alt Player not found
        a->u : 400 Bad Request
        a->u : "Player not found with ID: playerId"
    else Player found
        a->a : Find inventory by market item's inventory ID
        alt Inventory not found
            a->u : 400 Bad Request
            a->u : "Inventory item not found with ID: inventoryId"
        else Inventory found
            a->a : Find account by player's account ID
            alt Account not found
                a->u : 400 Bad Request
                a->u : "Account not found for player with ID: playerId"
            else Account found
                a->a : Check if player owns the inventory
                alt Player does not own the inventory
                    a->u : 400 Bad Request
                    a->u : "You are not authorized to purchase this item."
                else Player owns the inventory
                    a->a : Check if market item is sold
                    alt Market item is sold
                        a->u : 400 Bad Request
                        a->u : "The item has already been sold."
                    else Market item is not sold
                        a->a : Check if player has enough balance
                        alt Player does not have enough balance
                            a->u : 400 Bad Request
                            a->u : "Your balance is insufficient."
                        else Player has enough balance
                            a->a : Deposit cost to seller's account
                            a->a : Withdraw cost from buyer's account
                            a->a : Change inventory owner to buyer
                            a->a : Set inventory as not on market
                            a->a : Mark market item as sold
                            a->a : Save market item
                            a->a : Add notification to seller's inbox
                            a->u : 200 OK
                            a->u : "Successfully purchased an item."
                            a->u : JSON Inventory data
                        end
                    end
                end
            end
        end
    end
end

@enduml
